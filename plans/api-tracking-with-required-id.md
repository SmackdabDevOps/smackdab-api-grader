# API Contract Tracking with Required Unique ID Plan

## Overview
Implement a system where every API contract MUST include a unique identifier (`x-api-id`) in the OpenAPI specification. This ID will be generated by a new MCP tool and becomes the primary tracking mechanism for API evolution.

## Key Concept
- **x-api-id**: A required vendor extension in the OpenAPI spec
- Generated once per API and persists across all versions
- Becomes a grading prerequisite (APIs without it fail validation)
- Enables precise tracking of API evolution and improvements

## Implementation Plan

### 1. New MCP Tool: `generate_api_id`
**Purpose**: Generate a unique, persistent API identifier

**Implementation**:
```typescript
// New file: /src/mcp/tools/api-id-generator.ts
export function generateApiId(metadata?: {
  organization?: string;
  domain?: string;
  type?: string;
}): string {
  const prefix = metadata?.organization || 'api';
  const timestamp = Date.now();
  const random = crypto.randomBytes(8).toString('hex');
  return `${prefix}_${timestamp}_${random}`;
  // Example: "acme_1736180423567_a3f8b2c9d4e5f6a7"
}
```

**MCP Tool Registration**:
- Tool name: `generate_api_id`
- Input: Optional organization/domain/type metadata
- Output: Unique API ID with usage instructions

### 2. OpenAPI Specification Requirements

**Required Location**: In the `info` section as a vendor extension
```yaml
openapi: 3.0.3
info:
  title: My API
  version: 1.0.0
  x-api-id: acme_1736180423567_a3f8b2c9d4e5f6a7  # REQUIRED
  x-api-created: "2025-01-06T12:00:00Z"          # Auto-added
  x-api-lineage:                                 # Optional
    parent-id: acme_1736180423566_b2f7a1c8d3e4f5a6
    fork-reason: "Feature branch for v2"
```

### 3. Validation Rules

**New Prerequisite Check**:
```typescript
// Add to /src/app/prerequisites.ts
export function checkApiId(spec: any): PrerequisiteResult {
  if (!spec?.info?.['x-api-id']) {
    return {
      passed: false,
      failures: [{
        ruleId: 'PREREQ-API-ID',
        severity: 'error',
        message: 'API specification missing required x-api-id. Generate one using generate_api_id tool.',
        location: '$.info',
        category: 'prerequisites'
      }]
    };
  }
  
  // Validate ID format
  const apiId = spec.info['x-api-id'];
  const validFormat = /^[a-z0-9]+_\d{13}_[a-f0-9]{16}$/;
  if (!validFormat.test(apiId)) {
    return {
      passed: false,
      failures: [{
        ruleId: 'PREREQ-API-ID-FORMAT',
        severity: 'error',
        message: 'Invalid x-api-id format. Use generate_api_id tool to create valid ID.',
        location: '$.info.x-api-id',
        category: 'prerequisites'
      }]
    };
  }
  
  return { passed: true, failures: [] };
}
```

### 4. Enhanced Database Schema

**Updated `api` table**:
```sql
CREATE TABLE api (
  api_uuid TEXT PRIMARY KEY,        -- The x-api-id from spec
  first_seen_at TIMESTAMP NOT NULL,
  last_seen_at TIMESTAMP NOT NULL,
  current_version TEXT,              -- Latest version from info.version
  api_title TEXT,                    -- From info.title
  organization TEXT,                 -- Extracted from api_uuid prefix
  domain TEXT,                       -- Business domain
  api_type TEXT,                     -- REST/GraphQL/gRPC (detected)
  parent_uuid TEXT,                  -- For tracking forks/lineage
  repository_url TEXT,               -- Git remote if available
  owner_email TEXT,                  -- From info.contact.email
  FOREIGN KEY(parent_uuid) REFERENCES api(api_uuid)
);

CREATE TABLE api_versions (
  version_id TEXT PRIMARY KEY,
  api_uuid TEXT NOT NULL,
  version_number TEXT NOT NULL,      -- From info.version
  spec_hash TEXT NOT NULL,
  first_graded_at TIMESTAMP,
  last_graded_at TIMESTAMP,
  best_score REAL,
  worst_score REAL,
  average_score REAL,
  grade_count INTEGER DEFAULT 0,
  FOREIGN KEY(api_uuid) REFERENCES api(api_uuid)
);

CREATE TABLE grading_metrics (
  run_id TEXT PRIMARY KEY,
  api_uuid TEXT NOT NULL,
  version_id TEXT NOT NULL,
  -- Category scores (0-100)
  functionality_score REAL,
  security_score REAL,
  design_score REAL,
  errors_score REAL,
  performance_score REAL,
  documentation_score REAL,
  -- Specific metrics for tracking
  endpoint_count INTEGER,
  schema_count INTEGER,
  has_pagination BOOLEAN,
  has_rate_limiting BOOLEAN,
  has_webhooks BOOLEAN,
  has_async_patterns BOOLEAN,
  auth_methods TEXT,              -- JSON array
  error_format TEXT,              -- none/basic/rfc7807
  response_envelope BOOLEAN,
  -- Coverage percentages
  endpoint_documented_pct REAL,
  schema_documented_pct REAL,
  example_coverage_pct REAL,
  test_coverage_pct REAL,
  FOREIGN KEY(run_id) REFERENCES run(run_id),
  FOREIGN KEY(api_uuid) REFERENCES api(api_uuid),
  FOREIGN KEY(version_id) REFERENCES api_versions(version_id)
);

CREATE TABLE improvement_tracking (
  tracking_id TEXT PRIMARY KEY,
  api_uuid TEXT NOT NULL,
  metric_category TEXT NOT NULL,   -- functionality/security/etc
  metric_name TEXT NOT NULL,       -- specific metric
  baseline_value REAL,             -- First recorded value
  baseline_date TIMESTAMP,
  current_value REAL,              -- Latest value
  current_date TIMESTAMP,
  best_value REAL,                 -- Best ever achieved
  best_date TIMESTAMP,
  improvement_pct REAL,            -- % change from baseline
  trend TEXT,                      -- improving/declining/stable
  FOREIGN KEY(api_uuid) REFERENCES api(api_uuid)
);
```

### 5. New MCP Tools

**A. `generate_api_id`**
- Generates unique API identifier
- Returns ID with instructions for adding to spec

**B. `validate_api_id`**
- Checks if an API has valid x-api-id
- Returns validation status and instructions if missing

**C. `get_api_history`**
- Retrieves full history for an api_uuid
- Shows version progression and score trends

**D. `get_api_improvements`**
- Shows improvement metrics over time
- Highlights areas of progress and regression

**E. `compare_api_versions`**
- Detailed comparison between two versions
- Shows what improved/degraded

**F. `get_api_analytics`**
- Comprehensive analytics for an API
- Trends, patterns, recommendations

### 6. Modified Grading Flow

```typescript
// Updated gradeContract function
export async function gradeContract(args: any, options: any) {
  // 1. Load spec
  const spec = await loadSpec(args.path);
  
  // 2. Check for x-api-id (prerequisite)
  const apiIdCheck = checkApiId(spec);
  if (!apiIdCheck.passed) {
    return {
      grade: { total: 0, letter: 'F', blockedByPrerequisites: true },
      findings: apiIdCheck.failures,
      message: 'Missing required x-api-id. Use generate_api_id tool first.'
    };
  }
  
  // 3. Extract API UUID and version
  const apiUuid = spec.info['x-api-id'];
  const apiVersion = spec.info.version || '0.0.0';
  
  // 4. Continue normal grading
  const result = await performGrading(spec, options);
  
  // 5. Calculate detailed metrics
  const metrics = await calculateMetrics(spec, result);
  
  // 6. Store in database with UUID as primary key
  await recordGrading(apiUuid, apiVersion, result, metrics);
  
  // 7. Calculate improvements
  const improvements = await calculateImprovements(apiUuid, metrics);
  
  return {
    ...result,
    apiUuid,
    version: apiVersion,
    metrics,
    improvements
  };
}
```

### 7. User Workflow

**First Time Setup**:
1. User/agent calls `generate_api_id` tool
2. Receives unique ID: `acme_1736180423567_a3f8b2c9d4e5f6a7`
3. Adds to OpenAPI spec under `info.x-api-id`
4. Submits for grading

**Subsequent Grading**:
1. Grader reads `x-api-id` from spec
2. Tracks as same API even if file moves
3. Compares against previous versions
4. Shows improvement trends

**Version Updates**:
1. User updates `info.version` but keeps same `x-api-id`
2. Grader tracks as new version of same API
3. Provides version comparison analytics

### 8. Migration Strategy

**Phase 1: Soft Launch**
- Add `generate_api_id` tool
- Make x-api-id optional with warnings
- Start collecting IDs for new APIs

**Phase 2: Enforcement**
- Make x-api-id required for new APIs
- Provide migration tool for existing APIs
- Generate IDs based on spec content hash for legacy

**Phase 3: Full Analytics**
- Enable all tracking features
- Provide improvement dashboards
- API evolution visualization

### 9. Benefits

1. **Stable Tracking**: API identity persists across file moves, renames
2. **Version History**: Clear progression tracking
3. **Improvement Metrics**: Quantifiable progress over time
4. **Cross-Team Visibility**: Same ID used by all teams/branches
5. **Lineage Tracking**: Fork relationships preserved
6. **Automated Analytics**: Rich insights without manual tracking

### 10. Files to Create/Modify

**New Files**:
- `/src/mcp/tools/api-id-generator.ts` - ID generation logic
- `/src/app/tracking/metrics-calculator.ts` - Detailed metrics extraction
- `/src/app/tracking/improvement-analyzer.ts` - Progress analysis
- `/src/app/tracking/version-comparator.ts` - Version comparison
- `/migrations/add-api-tracking-tables.sql` - Database migration

**Modified Files**:
- `/src/app/prerequisites.ts` - Add x-api-id check
- `/src/app/pipeline.ts` - Use x-api-id for tracking
- `/src/mcp/server.ts` - Register new tools
- `/src/mcp/server-sse-simple.ts` - Add new tool endpoints
- `/src/mcp/persistence/db.ts` - New tracking methods
- `/src/mcp/persistence/db-postgres.ts` - New tracking methods

This approach provides explicit, stable API identification while enabling comprehensive tracking and analytics.